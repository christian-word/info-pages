<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Біблійний Експерт. Оцінка Глибини Знань</title>
    <style>
        /* CSS залишається незмінним, додано лише стилі для textarea */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        body { 
            /* Новий фон - Темно-зелений/сірий градієнт */
            background: linear-gradient(135deg, #37474F 0%, #1B5E20 100%);
            min-height: 100vh;
            padding: 20px; 
            color: #333;
        }

        .container { 
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            /* Новий фон хедера - Глубокий Лесной Зеленый */
            background: linear-gradient(135deg, #004D40 0%, #2E7D32 100%);
            color: white;
            padding: 80px 30px 40px; 
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        .header-actions {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex; 
            gap: 10px;
        }

        .settings-btn, .help-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: 0.3s;
            backdrop-filter: blur(10px);
            white-space: nowrap;
        }

        .settings-btn:hover, .help-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .content {
            padding: 40px 30px;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlide 0.3s;
        }

        @keyframes modalSlide {
            from { transform: scale(0.9) translateY(-20px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }

        .modal-header {
            /* Новий фон модального вікна */
            background: linear-gradient(135deg, #004D40 0%, #2E7D32 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: 0.3s;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .modal-body {
            padding: 30px;
        }

        .help-section h3 {
            /* Новий акцентний колір */
            color: #004D40;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        .help-section p {
            margin-bottom: 15px;
            line-height: 1.6;
            color: #555;
        }
        .help-section ul {
            list-style: disc;
            margin-left: 20px;
            margin-bottom: 15px;
        }
        .help-section li {
            margin-bottom: 5px;
            color: #555;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            /* Новий колір фокуса */
            border-color: #004D40;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        /* СТИЛЬ ДЛЯ ВСІХ ОСНОВНИХ КНОПОК */
        .btn {
            flex: 1;
            padding: 12px 20px;
            border: none; 
            border-radius: 25px; 
            font-size: 0.95rem;
            cursor: pointer;
            transition: 0.3s;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* --- НОВИЙ УНІФІЦОВАНІЙ СТИЛЬ КНОПОК З ОКАНТОВКОЮ --- */
        
        /* PRIMARY BUTTONS (ОКАНТОВКА) */
        .btn-primary {
            background: white; 
            /* Основний колір */
            color: #004D40; 
            border: 2px solid #004D40; 
        }

        .btn-primary:hover {
            /* Новий колір при наведенні */
            background: #E8F5E9; /* Дуже Бледно-зелений */
            transform: translateY(-2px);
            box-shadow: none;
        }

        /* SECONDARY BUTTONS (ОКАНТОВКА) */
        .btn-secondary {
            background: white; 
            /* Основний колір */
            color: #004D40; 
            border: 2px solid #004D40; 
        }

        .btn-secondary:hover {
            /* Новий колір при наведенні */
            background: #E8F5E9;
            transform: translateY(-2px);
        }
        
        /* DANGER BUTTONS (СОХРАНЯЕМ SOLID ДЛЯ ВИЗУАЛЬНОГО РАЗДЕЛЕНИЯ) */
        .btn-danger {
            background: #ff6b6b;
            color: white;
            border-radius: 25px;
            border: 2px solid #ff6b6b; /* Добавляем бордер для консистенции толщины */
        }

        .btn-danger:hover {
            background: #ff5252;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f8f9fa !important;
            color: #999 !important;
            border-color: #e0e0e0 !important;
        }

        .status {
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            margin-top: 10px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }

        .status.loading {
            background: #fff3cd;
            color: #856404;
            display: block;
        }

        /* START SCREEN */
        .theme-input-section {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .theme-input-section input {
            width: 100%;
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .theme-input-section input:focus {
            outline: none;
            /* Новий колір фокуса */
            box-shadow: 0 4px 20px rgba(0,77,64,0.3);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        /* RESTORE BANNER */
        .restore-test-banner {
            /* Новий фон */
            background: #E8F5E9;
            /* Новий колір тексту */
            color: #004D40;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            /* Новий колір рамки */
            border: 1px solid #A5D6A7;
        }

        .restore-test-banner.show {
            display: flex;
        }

        .restore-test-banner button {
            /* Новий фон кнопки */
            background: #004D40;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: 0.3s;
        }

        .restore-test-banner button:hover {
            /* Новий колір при наведенні */
            background: #2E7D32;
        }

        /* BIG BUTTONS */
        .big-btn {
            padding: 20px;
            border: none;
            border-radius: 25px; 
            font-size: 1.1rem;
            cursor: pointer;
            transition: 0.3s;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
        }

        .big-btn.btn-primary {
            background: white; 
            color: #004D40; 
            border: 2px solid #004D40;
        }

        .big-btn.btn-secondary {
            background: white; 
            color: #004D40; 
            border: 2px solid #004D40;
        }

        .big-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(0,0,0,0.15);
            background: #E8F5E9;
        }

        .big-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .theme-suggestion {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 1.05rem;
            display: none;
        }

        .theme-suggestion.show {
            display: block;
        }

        /* HISTORY */
        .history-section {
            margin-top: 30px;
        }

        .history-toggle {
            width: 100%;
            padding: 15px;
            background: white;
            /* Новий колір */
            border: 2px solid #004D40; 
            border-radius: 25px; 
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            /* Новий колір тексту */
            color: #004D40; 
            transition: 0.3s;
        }

        .history-toggle:hover {
            /* Новий колір при наведенні */
            background: #E8F5E9;
            transform: translateY(-2px);
        }

        .history-list {
            display: none;
            margin-top: 15px;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .history-list.show {
            display: grid;
        }

        .history-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px; 
            padding: 20px;
            cursor: pointer;
            transition: 0.3s;
            position: relative;
        }

        .history-card:hover {
            /* Новий колір при наведенні */
            border-color: #004D40;
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,77,64,0.2);
        }
        
        /* ЦВЕТОВАЯ КОДИРОВКА КАРТОЧЕК */
        .history-card.insight-5 { border: 2px solid #28a745; background: #d4edda; }
        .history-card.insight-4 { border: 2px solid #ffc107; background: #fff3cd; }
        .history-card.insight-1, .history-card.insight-2 { border: 2px solid #dc3545; background: #f8d7da; }


        .history-card.preset {
            background: linear-gradient(135deg, #f5f7fa 0%, #e8eef7 100%);
            /* Новий колір */
            border: 2px dashed #004D40;
        }

        .history-card-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .history-card-score {
            /* Новий колір */
            color: #004D40;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .history-card-date {
            color: #999;
            font-size: 0.85rem;
            margin-top: 5px;
        }

        /* TEST SCREEN */
        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .test-title {
            font-size: 1.8rem;
            color: #333;
            margin-bottom: 15px;
        }

        .insight-badge {
            display: inline-block;
            /* Новий фон */
            background: linear-gradient(135deg, #004D40 0%, #2E7D32 100%);
            color: white;
            padding: 10px 25px;
            border-radius: 25px;
            font-weight: 600;
        }

        .progress-section {
            margin: 20px 0;
        }

        .progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress {
            height: 100%;
            /* Новий градієнт */
            background: linear-gradient(90deg, #004D40 0%, #2E7D32 100%);
            transition: width 0.5s ease;
        }

        .question-counter {
            text-align: right;
            color: #999;
            font-size: 0.9rem;
        }

        .question-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .question-text {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 25px;
            color: #333;
        }
        
        /* НОВІ СТИЛІ ДЛЯ ТЕКСТОВОГО ВВЕДЕННЯ */
        #answer-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1.05rem;
            min-height: 200px;
            resize: vertical;
            transition: border-color 0.3s;
        }

        #answer-input:focus {
            outline: none;
            /* Новий колір фокуса */
            border-color: #004D40;
        }
        
        .options-list { /* Цей клас більше не використовується */
            list-style: none;
        }

        .option { /* Цей клас більше не використовується */
            list-style: none;
        }

        .option:hover { /* Цей клас більше не використовується */
            border-color: #004D40;
            transform: translateX(5px);
        }

        .option.selected { /* Цей клас більше не використовується */
            background: linear-gradient(135deg, #004D40 0%, #2E7D32 100%);
            color: white;
            border-color: #004D40;
        }

        .ai-helper {
            /* Новий колір фона і лівої границі */
            background: #F1F8E9; /* Дуже світлий зелений */
            border-left: 4px solid #8BC34A; /* Світло-зелений */
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            /* display: none; */ /* AI Helper завжди видимий у цій концепції */
        }

        .ai-helper.hide {
            display: none;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 15px;
        }

        .nav-btn-group {
            display: flex;
            gap: 10px;
        }

        /* RESULT SCREEN */
        .result-container {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }

        .result-container.show {
            display: block;
        }

        .score-circle {
            width: 200px;
            height: 200px;
            margin: 30px auto;
            border-radius: 50%;
            /* Новий градієнт */
            background: linear-gradient(135deg, #004D40 0%, #2E7D32 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            /* Нова тінь */
            box-shadow: 0 10px 40px rgba(0,77,64,0.3);
        }

        .score-number {
            font-size: 3rem;
            font-weight: bold;
        }

        .score-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .result-message {
            font-size: 1.5rem;
            margin: 20px 0;
            color: #333;
        }

        .answers-review {
            margin-top: 30px;
            text-align: left;
        }
        
        /* НОВІ СТИЛІ ДЛЯ REVIEW */
        .review-item {
            background: #f8f9fa;
            padding: 20px;
            margin: 15px 0;
            border-radius: 12px;
            border-left: 4px solid #e0e0e0;
        }

        .review-item.good {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .review-item.medium {
            border-left-color: #ffc107;
            background: #fff3cd;
        }

        .review-item.poor {
            border-left-color: #dc3545;
            background: #f8d7da;
        }

        .user-answer-box {
            background: white;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-style: italic;
            color: #555;
            white-space: pre-wrap; /* зберігає форматування тексту */
        }
        
        .feedback-box {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            /* Новий колір */
            border: 1px dashed #004D40;
            /* Новий фон */
            background: #E8F5E9;
        }


        .correct-text { color: #28a745; font-weight: 600; }
        .incorrect-text { color: #dc3545; font-weight: 600; }

        .hidden-verse {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            font-style: italic;
            color: #155724;
            display: none;
        }

        .hidden-verse.show {
            display: block;
        }

        /* MUSIC CONTROLS */
        .music-controls {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 999;
        }
        
        .music-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: 0.3s;
            backdrop-filter: blur(10px);
            padding: 0;
            border-radius: 50%; 
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .music-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .ai-toggle-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            display: block; /* Зробили видимим */
        }

        .ai-toggle-section label {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 500;
        }

        .ai-toggle-section input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .footer {
            text-align: center;
            color: #fff;
            padding: 20px 0;
            font-size: 0.85em;
            opacity: 0.8;
            margin-top: 30px;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                border-radius: 15px;
            }
            
            .header { 
                padding: 80px 15px 30px; 
            }
            
            .header h1 { 
                font-size: 1.8rem; 
            }
            
            .header-actions {
                top: 15px;
                right: 15px;
                gap: 8px;
            }

            .settings-btn, .help-btn {
                padding: 8px 15px;
            }
            
            .content {
                padding: 30px 10px 100px; 
            }
            
            .action-buttons { 
                grid-template-columns: 1fr; 
                gap: 10px;
            }
            
            .history-list { 
                grid-template-columns: 1fr; 
                gap: 10px;
            }
            
            .navigation { 
                flex-direction: column; 
                gap: 10px;
            }
            
            .nav-btn-group { 
                width: 100%;
                gap: 10px;
            }
            
            .music-controls { 
                bottom: 10px;
                right: 10px; 
            }
            
            .music-btn {
                font-size: 1.2rem;
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>
<body>

<div id="loading-overlay" class="loading-overlay">
    <div class="spinner"></div>
    <p id="loading-message">🤖 ІІ генерує тест...</p>
</div>

<style>
    /* Стилі для спіннера */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        display: none; 
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        /* Новий колір */
        color: #004D40;
        font-size: 1.2em;
        transition: opacity 0.3s;
    }
    .spinner {
        border: 8px solid #f3f3f3;
        /* Новий колір */
        border-top: 8px solid #004D40;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

    <div class="container">
        <div class="header">
            <div class="header-actions">
                <button class="help-btn" id="help-btn">❓ Допомога</button>
                <button class="settings-btn" id="settings-btn">⚙️ Налаштування</button>
            </div>
            <h1>📜 Біблійний Експерт</h1>
            <p class="subtitle">Розширений аналіз ваших відкритих відповідей за допомогою Groq API.</p>
        </div>

        <div class="modal" id="help-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>❓ Допомога та FAQ</h2>
                    <button class="close-btn" id="close-help-modal">×</button>
                </div>
                <div class="modal-body help-section">
                    <h3>Що таке "Біблійний Експерт"?</h3>
                    <p>Це новий формат навчального інструмента для глибшого вивчення Біблії. Замість тестів із варіантами ви повинні дати **відкриту, деталізовану відповідь** на складне питання. Штучний Інтелект виступає в ролі **об’єктивного оцінювача**, який аналізує вашу відповідь за 5-бальною шкалою, порівнюючи її з ключовими біблійними фактами та критеріями.</p>
                    
                    <h3>Як ШІ оцінює мою відповідь?</h3>
                    <p>Ваша відповідь оцінюється за **5-бальною шкалою (від 1 до 5)**. ШІ не просто шукає ключові слова, а проводить **семантичний аналіз**, порівнюючи вашу аргументацію з **критеріями правильності**, які були згенеровані для цього завдання.</p>
                    <p>Чим більше **ключових біблійних фактів, цитат, богословських ідей та контексту** ви надасте у своїй відповіді, тим вищим буде бал. Оцінка 5/5 означає, що ви розкрили всі ключові аспекти, вказані в критеріях ШІ.</p>
                    
                    <h3>Рівні Складності</h3>
                    <p>Рівень складності впливає на глибину питань та критерії оцінювання:</p>
                    <ul>
                        <li>**1. Факти:** Питання про імена, місця та послідовність подій. Відповіді вимагають чітких фактів.</li>
                        <li>**2. Тлумачення:** Питання, що вимагають розуміння значення та контексту подій.</li>
                        <li>**3. Богослов'я:** Глибокі питання про духовний, символічний та богословський сенс біблійних уривків.</li>
                    </ul>

                    <h3>Результати та Відгуки</h3>
                    <p>Після завершення тесту ШІ оцінює кожну вашу відповідь. Ви отримаєте бал від **1 до 5** за кожне завдання, а також детальний відгук із зазначенням пропущених ключових елементів та біблійних віршів, які можуть покращити ваше розуміння теми.</p>

                    <h3>Використання ІІ</h3>
                    <p>Ця програма використовує передові моделі ІІ (Groq), які потребують вашого особистого API ключа для генерації та оцінювання. Ваш ключ зберігається лише у вашому браузері і нікуди не передається. <strong>Зверніть увагу: Groq не надає безкоштовний доступ, вам потрібно буде його придбати.</strong></p>

                    <h3>Контакти</h3>
                    <p>Цей проект був створений у м. Суми, © 2025 р. З питань та пропозицій звертайтеся до розробника.</p>
                </div>
            </div>
        </div>
        <div class="modal" id="settings-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>⚙️ Налаштування</h2>
                    <button class="close-btn" id="close-modal">×</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>🔑 API ключ Groq</label>
                        <input type="password" id="api-key" placeholder="Введи ключ з console.groq.com" value="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"> 
                        <div class="btn-group">
                            <button class="btn btn-secondary" id="test-key-btn">🧪 Тест ключа</button>
                        </div>
                        <div id="key-status" class="status"></div>
                    </div>

                    <div class="form-group">
                        <label>🤖 Модель ІІ</label>
                        <select id="model-select" disabled>
                            <option>Завантаження моделей...</option>
                        </select>
                        <div class="btn-group">
                            <button class="btn btn-secondary" id="refresh-models" disabled>🔄 Оновити</button>
                        </div>
                        <div id="model-status" class="status"></div>
                    </div>

                    <div class="form-group">
                        <label>🎵 Фонова музика</label>
                        <select id="music-select">
                            <option value="none">Без музики</option>
                            <option value="default" selected>Спокійна (за замовчуванням)</option>
                            <option value="ambient">Ambient meditation</option>
                            <option value="piano">Peaceful piano</option>
                            <option value="nature">Nature sounds</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="creativity-slider">Креативність ШІ (Temperature): <span id="creativity-value">0.7</span></label>
                        <input type="range" id="creativity-slider" min="0.1" max="1.0" step="0.1" value="0.7">
                        <small style="display:block;margin-top:5px;color:#777;">Вище значення (ближче до 1.0) дає більш різноманітні, але менш точні питання. Рекомендовано: 0.7-0.8.</small>
                    </div>
                    
                    <div class="form-group">
                        <label>🔊 Гучність музики</label>
                        <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="30">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-danger" id="clear-history" style="width: 100%;">🗑️ Очистити історію</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="content" id="start-screen">

            <div class="restore-test-banner" id="restore-test-banner">
                <span>↩️ Є незавершений тест: <span id="restored-theme-name"></span></span>
                <button id="restore-btn">Продовжити</button>
            </div>
            
            <div class="form-group" style="margin-bottom: 20px;">
                <label for="difficulty-select">Оберіть Рівень Складності Завдання:</label>
                <select id="difficulty-select" class="input-field"></select>
            </div>
            <div class="theme-input-section">
                <input type="text" id="theme-input" placeholder="Введи тему для відкритого завдання (наприклад: Вихід з Єгипту)">
                <div class="action-buttons">
                    <button class="big-btn btn-primary" id="generate-test" disabled>✨ Створити завдання</button>
                    <button class="big-btn btn-secondary" id="suggest-theme" disabled>🎲 Випадкова тема</button>
                </div>
                <button class="big-btn btn-secondary" id="show-example-btn" style="width: 100%; margin-top: 15px;">
                    🎬 Показати Приклад (Демо)
                </button>
                <div class="theme-suggestion" id="theme-suggestion"></div>
            </div>

            <div class="history-section">
                <button class="history-toggle" id="show-history">📘 Історія аналізів</button>
                <div class="history-list" id="history-list"></div>
            </div>
        </div>

        <div class="content" id="test-screen" style="display: none;">
            <div class="test-header">
                <h2 class="test-title" id="current-theme-title"></h2>
                <div class="insight-badge" id="insight-badge">Рівень: 1 (Новачок)</div>
            </div>
            
            <div class="ai-toggle-section">
                <label>
                    <input type="checkbox" id="ai-hints-toggle">
                    💡 Показати критерії та підказки (Verse Key)
                </label>
            </div>

            <div class="progress-section">
                <div class="progress-bar">
                    <div class="progress" id="progress"></div>
                </div>
                <div class="question-counter" id="question-counter">Завдання 1 з 1</div>
            </div>

            <div class="question-card">
                <div class="question-text" id="question-text-open"></div>
                <textarea id="answer-input" placeholder="Введіть вашу відповідь, використовуючи біблійні факти та цитати..." rows="8"></textarea>
            </div>
            
            <div class="ai-helper" id="ai-helper">
                </div>
            <div class="navigation">
                <button class="btn btn-secondary" id="home-btn">🏠 На головну</button>
                <div class="nav-btn-group">
                    <button class="btn btn-secondary" id="prev-btn" disabled>⬅️ Назад</button>
                    <button class="btn btn-primary" id="next-btn">Далі ➡️</button>
                </div>
            </div>
        </div>

        <div class="content result-container" id="result-container">
            <h2>🎉 Результати Оцінювання</h2>
            <div class="score-circle">
                <div class="score-number" id="score">0/0</div>
                <div class="score-label">Сума балів ІІ (max 5 за завдання)</div>
            </div>
            <div class="result-message" id="result-message"></div>
            <div class="insight-badge" id="result-insight">Рівень: 1</div>
            <div class="hidden-verse" id="hidden-verse"></div>
            <div class="answers-review" id="answers-review"></div>
            <div class="btn-group" style="max-width: 400px; margin: 30px auto 0;">
                <button class="btn btn-primary" id="retry-btn">🔄 Пройти ще раз</button>
                <button class="btn btn-secondary" id="home-btn-2">🏠 На головну</button>
            </div>
        </div>
    </div>

    <div class="music-controls">
        <button class="music-btn" id="music-toggle">🎵</button>
    </div>

    <audio id="background-music" loop preload="auto">
        <source src="https://raw.githubusercontent.com/christian-word/info-pages/main/test-bibleAIExpert/Beautiful-Day.mp3" type="audio/mp3">
    </audio>
    <footer class="footer">
        © верс. 1.0 Біблійний Експерт | м. Суми, © 2025 р.
    </footer>

    <script>
        const API_URL = 'https://api.groq.com/openai/v1/chat/completions';
        const MODELS_URL = 'https://api.groq.com/openai/v1/models';
        const STORAGE_KEY = 'bibleSleedoput_History';
        const MODEL_STORAGE_KEY = 'bibleSleedoput_Model';
        const KEY_STORAGE_KEY = 'bibleSleedoput_Key';
        const MUSIC_STORAGE_KEY = 'bibleSleedoput_Music';
        const VOLUME_STORAGE_KEY = 'bibleSleedoput_Volume';
        const DIFFICULTY_STORAGE_KEY = 'bibleSleedoput_Difficulty';
        const CREATIVITY_STORAGE_KEY = 'bibleSleedoput_Creativity';
        const HINTS_TOGGLE_STORAGE = 'bibleSleedoput_HintsToggle'; // НОВИЙ ключ для підказок

        // КЛЮЧІ ДЛЯ ЗБЕРЕЖЕННЯ ПРОГРЕСУ ТЕСТУ
        const CURRENT_TEST_STORAGE = 'bibleSleedoput_CurrentTest';
        const CURRENT_QUESTION_STORAGE = 'bibleSleedoput_CurrentQuestion';
        const USER_ANSWERS_STORAGE = 'bibleSleedoput_UserAnswers';
        const AI_GRADES_STORAGE = 'bibleSleedoput_AIGrades';
        

        // FALLBACK-МОДЕЛІ
        const FALLBACK_MODELS = [
            { id: 'llama-3.1-405b-reasoning', name: 'Llama 3.1 405b' },
            { id: 'llama-3.1-70b-versatile', name: 'Llama 3.1 70b' },
            { id: 'llama-3.1-8b-instant', name: 'Llama 3.1 8b' },
            { id: 'llama-3.3-70b-versatile', name: 'Llama 3.3 70b' },
            { id: 'mixtral-8x7b-g', name: 'Mixtral 8x7b' }
        ];

        // ЗБЕРЕЖЕНА ІСТОРІЯ ТЕСТІВ
        let history = []; 
        let currentTest = null;
        let currentQuestion = 0;
        let userAnswers = {};
        let aiGrades = {}; 
        let models = [];
        let selectedModel = '';
        let selectedDifficulty = localStorage.getItem(DIFFICULTY_STORAGE_KEY) || 'theology';
        let currentVolume = parseFloat(localStorage.getItem(VOLUME_STORAGE_KEY)) || 30;
        let currentCreativity = parseFloat(localStorage.getItem(CREATIVITY_STORAGE_KEY) || '0.7');
        let creativityManuallyChanged = false;

        // === DOM elements ===
        const settingsBtn = document.getElementById('settings-btn');
        const helpBtn = document.getElementById('help-btn');
        const settingsModal = document.getElementById('settings-modal');
        const helpModal = document.getElementById('help-modal');
        const closeModal = document.getElementById('close-modal');
        const closeHelpModal = document.getElementById('close-help-modal');
        const apiKeyInput = document.getElementById('api-key');
        const testKeyBtn = document.getElementById('test-key-btn');
        const keyStatus = document.getElementById('key-status');
        const modelSelect = document.getElementById('model-select');
        const refreshModelsBtn = document.getElementById('refresh-models');
        const modelStatus = document.getElementById('model-status');
        const musicSelect = document.getElementById('music-select');
        // Елементи для керування екранами
        const startScreen = document.getElementById('start-screen');
        const testScreen = document.getElementById('test-screen');
        const resultContainer = document.getElementById('result-container');
        const hiddenVerse = document.getElementById('hidden-verse');
        const themeInput = document.getElementById('theme-input');
        const generateTestBtn = document.getElementById('generate-test');
        const suggestThemeBtn = document.getElementById('suggest-theme');
        const themeSuggestion = document.getElementById('theme-suggestion');
        const showHistoryBtn = document.getElementById('show-history');
        const clearHistoryBtn = document.getElementById('clear-history');
        const historyList = document.getElementById('history-list');
        const currentThemeTitle = document.getElementById('current-theme-title');
        const aiHelper = document.getElementById('ai-helper');
        const aiHintsToggle = document.getElementById('ai-hints-toggle'); // ВІДНОВЛЕНО
        const progress = document.getElementById('progress');
        const questionCounter = document.getElementById('question-counter');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const scoreEl = document.getElementById('score');
        const resultMsg = document.getElementById('result-message');
        const answersReview = document.getElementById('answers-review');
        const music = document.getElementById('background-music');
        const musicToggle = document.getElementById('music-toggle');
        const volumeSlider = document.getElementById('volume-slider');
        const difficultySelect = document.getElementById('difficulty-select');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingMessage = document.getElementById('loading-message');
        const creativitySlider = document.getElementById('creativity-slider');
        const creativityValueEl = document.getElementById('creativity-value');
        // Елементи для нового інтерфейсу
        const questionTextOpen = document.getElementById('question-text-open');
        const answerInput = document.getElementById('answer-input');
        const restoreTestBanner = document.getElementById('restore-test-banner');
        const restoreBtn = document.getElementById('restore-btn');
        const restoredThemeName = document.getElementById('restored-theme-name');
        const homeBtn = document.getElementById('home-btn');
        const homeBtn2 = document.getElementById('home-btn-2');
        const retryBtn = document.getElementById('retry-btn');
        // Елемент для нової кнопки прикладу
        const showExampleBtn = document.getElementById('show-example-btn');


        // ШАБЛОНИ ДЛЯ ГЕНЕРАЦІЇ ПИТАНЬ
        const DIFFICULTIES = [
            { id: 'facts', name: '1. Факти (Легкий)', temp: 0.3, system: 'Ти — біблійний педагог. Створюй прості питання, що вимагають чітких, фактичних біблійних відповідей (імена, місця, послідовність).', user_template: 'Створи біблійний тест на тему: "${theme}". 5 завдань. Кожне завдання має бути сформульоване як відкрите питання, що вимагає фактичної відповіді. Поверни лише JSON, де для кожного завдання є поля: "q" (питання), "correct_criteria" (список ключових фактів, які повинні бути в відповіді, 3-5 пунктів) та "verse_key" (ключовий біблійний вірш/глава). Формат JSON: {"questions": [{"q": "Питання?", "correct_criteria": ["критерій 1","критерій 2"], "verse_key": "Приклад 1:1"}]}' },
            { id: 'interpretation', name: '2. Тлумачення (Середній)', temp: 0.7, system: 'Ти — біблійний проповідник. Створюй питання, що вимагають розуміння контексту, значення та тлумачення біблійних подій.', user_template: 'Створи біблійний тест на тему: "${theme}". 5 завдань. Кожне завдання має бути сформульоване як відкрите питання, що вимагає тлумачення. Поверни лише JSON, де для кожного завдання є поля: "q" (питання), "correct_criteria" (список ключових богословських ідей, які повинні бути в відповіді, 3-5 пунктів) та "verse_key" (ключовий біблійний вірш/глава). Формат JSON: {"questions": [{"q": "Питання?", "correct_criteria": ["критерій 1","критерій 2"], "verse_key": "Приклад 1:1"}]}' },
            { id: 'theology', name: '3. Богослов\'я (Глибоко)', temp: 0.9, system: 'Ти — **біблійний екзегет**. Створюй питання, які вимагають **глибокого розуміння, символічного тлумачення та богословського сенсу** біблійних подій. Відповідь має бути розгорнутою і включати цитати.', user_template: 'Створи біблійний тест на тему: "${theme}". 5 завдань. Кожне завдання має бути сформульоване як відкрите питання, що вимагає богословського аналізу. Поверни лише JSON, де для кожного завдання є поля: "q" (питання), "correct_criteria" (список ключових богословських ідей та цитат, які повинні бути в відповіді, 3-5 пунктів) та "verse_key" (ключовий біблійний вірш/глава). Формат JSON: {"questions": [{"q": "Питання?", "correct_criteria": ["критерій 1","критерій 2"], "verse_key": "Приклад 1:1"}]}' }
        ];

        // ШАБЛОН ДЛЯ ОЦІНЮВАННЯ ВІДПОВІДЕЙ (Новий промпт для другого виклику Groq)
        const GRADING_SYSTEM_PROMPT = 'Ти — суворий і справедливий біблійний експерт. Твоя мета — оцінити відповідь учня за 5-бальною шкалою (1 – дуже погано, 5 – ідеально). Оцінка базується на точності, повноті та відповідності біблійним критеріям. Відповідай СТРОГО ТІЛЬКИ JSON і нічого більше. Згенеруй JSON об\'єкт із полями: "score" (ціле число від 1 до 5), "feedback" (стисле пояснення оцінки, що добре і що пропущено), "missing_elements" (список ключових елементів з критеріїв, яких не вистачає), "insight_verse" (біблійний вірш/фраза, що слугує підказкою для покращення).';

        // ДОСТУПНА ФОНОВА МУЗИКА
        const MUSIC_TRACKS = [
            { id: 'none', name: 'Без музики', url: '' },
            { id: 'default', name: 'Спокійна (за замовчуванням)', url: 'https://raw.githubusercontent.com/christian-word/info-pages/main/test-bibleAIExpert/Beautiful-Day.mp3' },
            { id: 'ambient', name: 'Ambient meditation', url: 'https://cdn.pixabay.com/audio/2024/02/09/audio_d086f6a70a.mp3' },
            { id: 'piano', name: 'Peaceful piano', url: 'https://cdn.pixabay.com/audio/2023/12/03/audio_03d987d3e6.mp3' },
            { id: 'nature', name: 'Nature sounds', url: 'https://cdn.pixabay.com/audio/2023/08/21/audio_4c98c60d8a.mp3' }
        ];

        // ПЕРЕДВСТАНОВЛЕНІ ТЕМИ
        const PRESET_THEMES = [
            { theme: '🌊 Перехід Червоного моря', difficulty: 'interpretation' },
            { theme: '⚔️ Падіння Єрихону', difficulty: 'facts' },
            { theme: '🐋 Історія Йони та кита', difficulty: 'theology' },
            { theme: '🍞 Хліби та риби', difficulty: 'interpretation' },
        ];


        // =======================================================
        // НОВИЙ РОЗДІЛ: MOCK-ДАНІ ДЛЯ ДЕМОНСТРАЦІЇ
        // =======================================================

        const MOCK_TEST_DATA = {
            theme: "Притча про блудного сина",
            date: new Date().toLocaleDateString('uk-UA'),
            questions: [
                {
                    q: "Яке богословське значення має вимога молодшого сина про свою частку маєтку?",
                    correct_criteria: [
                        "Символ вільної волі, наданої людині Богом.",
                        "Рішення 'померти' для батька (Бога) та відокремитися від дому.",
                        "Спадщина — це дар Божої благодаті, яким можна зловживати.",
                        "Початок гріхопадіння і відчуження."
                    ],
                    verse_key: "Луки 15:12"
                },
                {
                    q: "Опишіть символізм повернення сина, зокрема ключові елементи: одяг, перстень, взуття та зарізане теля.",
                    correct_criteria: [
                        "Покаяння — усвідомлення свого падіння та прихід як 'наймита', а не сина.",
                        "Одяг, перстень, взуття — символи повного відновлення синівського статусу і гідності.",
                        "Зарізане теля — символ великої радості (святкування) та прообраз жертовності Христа (хоча це глибоке тлумачення)."
                    ],
                    verse_key: "Луки 15:22-24"
                }
            ]
        };

        const MOCK_ANSWERS = {
            0: "Молодший син вимагає свою частку, що символізує бажання людини жити власним розумом і незалежно від Бога. Батько поважає його вільний вибір, хоча це призводить до гріха та страждань. Він втратив все, що мав, тому що відвернувся від джерела свого багатства.",
            1: "Повернення символізує покаяння. Батько прийняв його без докорів, показуючи безумовну любов Бога. Перстень — влада та почесті, одяг — праведність, а взуття — що він більше не раб. Це повне відновлення благодаті, а теля — велика радість на небі про грішника, що покаявся."
        };

        const MOCK_GRADES = {
            0: {
                score: 4,
                feedback: "Відповідь сильна. Вказано ідею вільної волі та наслідки гріха. Пропущено: згадка про спадщину як про дар благодаті, яким можна зловживати.",
                missing_elements: [
                    "Спадщина — це дар Божої благодаті.",
                    "Рішення 'померти' для батька (Бога)."
                ],
                insight_verse: "Луки 15:12"
            },
            1: {
                score: 5,
                feedback: "Ідеальна відповідь! Вичерпно описано всі ключові символи (перстень, одяг, теля) та їхнє богословське значення (безумовна любов, відновлення статусу).",
                missing_elements: [],
                insight_verse: "Луки 15:24"
            }
        };

        // =======================================================
        // ФУНКЦІЯ ЗАПУСКУ ДЕМО-РЕЖИМУ
        // =======================================================

        async function loadExampleTest() {
            if (!confirm("Ви впевнені, що хочете запустити демонстраційний режим? Всі дані незавершеного тесту (якщо є) будуть втрачені.")) {
                return;
            }

            // 1. Скидання інтерфейсу
            toggleLoader(true, '🎬 Підготовка демонстраційного аналізу...');

            // 2. Імітація процесу
            currentTest = MOCK_TEST_DATA;
            userAnswers = MOCK_ANSWERS;
            aiGrades = MOCK_GRADES;

            // 3. Зберігаємо мок-тест, щоб він з'явився в історії
            const totalScore = Object.values(aiGrades).reduce((sum, grade) => sum + grade.score, 0);
            const maxScore = currentTest.questions.length * 5;
            const averageScore = totalScore / currentTest.questions.length;
            const insight = Math.min(5, Math.ceil(averageScore));

            const result = { 
                theme: currentTest.theme + " (ДЕМО)", 
                score: totalScore, 
                total: maxScore, 
                date: currentTest.date, 
                insight,
                fullTest: currentTest,    
                fullGrades: aiGrades      
            };
            history.push(result);
            saveHistory();
            
            // 4. Імітуємо затримку оцінювання для візуального ефекту 'відео'
            await new Promise(resolve => setTimeout(resolve, 3000)); 

            // 5. Одразу переходимо до відображення результатів
            testScreen.style.display = 'none';
            startScreen.style.display = 'none';
            resultContainer.classList.add('show');
            
            displayFinalResults(); // Ця функція використає дані з MOCK_GRADES
            
            toggleLoader(false);
        }

        // =======================================================
        // ОСНОВНІ ФУНКЦІЇ РОБОТИ З API ТА UI
        // =======================================================


        function toggleLoader(show, message = '🤖 ІІ генерує тест...') {
            loadingMessage.textContent = message;
            loadingOverlay.style.display = show ? 'flex' : 'none';
            // Блокуємо скрол під час завантаження
            document.body.style.overflow = show ? 'hidden' : 'auto';
        }

        async function callGroqAPI(messages, max_tokens, temperature) {
            const key = apiKeyInput.value.trim();
            if (!key) throw new Error('API ключ не введений!');
            if (!selectedModel) throw new Error('Модель ІІ не обрана!');
            
            const payload = {
                model: selectedModel,
                messages: messages,
                max_tokens: max_tokens,
                temperature: temperature,
                stream: false
            };

            const res = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${key}`
                },
                body: JSON.stringify(payload)
            });

            if (!res.ok) {
                const errorData = await res.json();
                const errorMessage = errorData.error ? errorData.error.message : `HTTP ${res.status}`;
                throw new Error(`Помилка Groq API: ${errorMessage}`);
            }

            const data = await res.json();
            return data.choices[0].message.content.trim();
        }

        /**
         * Улучшенная функция для безпечного парсингу JSON
         */
        async function parseAndValidateJSON(jsonStr, messages, max_tokens) {
            let cleanJsonStr = jsonStr.replace(/```json|```/g, '').trim();
            const firstBrace = cleanJsonStr.indexOf('{');
            const lastBrace = cleanJsonStr.lastIndexOf('}');

            if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
                cleanJsonStr = cleanJsonStr.substring(firstBrace, lastBrace + 1);
            }

            try {
                const parsed = JSON.parse(cleanJsonStr);
                // Базова перевірка, що це схоже на об'єкт
                if (parsed.questions && Array.isArray(parsed.questions) && parsed.questions.length > 0) {
                    return parsed;
                }
                if (parsed.score && parsed.feedback) { 
                    // Перевірка для JSON оцінки
                    return parsed;
                }
                throw new Error("JSON не містить очікуваних полів.");
            } catch (e) {
                console.warn(`Перша спроба парсинга JSON провалилася: ${e.message}. Повторна спроба генерації.`);
                // --- ЛОГІКА АВТОМАТИЧНОЇ ПОВТОРНОЇ СПРОБИ ---
                loadingMessage.textContent = '⚠️ Помилка формату. Спроба перегенерації...';
                
                const retryMessages = [
                    ...messages,
                    { role: 'system', content: 'Твій попередній відповідь була некоректною JSON-структурою. Відповідай СТРОГО ТІЛЬКИ JSON і нічого більше. Повтори генерацію.' }
                ];
                
                const secondAttemptStr = await callGroqAPI(retryMessages, max_tokens, currentCreativity);
                let cleanSecondAttempt = secondAttemptStr.replace(/```json|```/g, '').trim();
                
                const secondFirstBrace = cleanSecondAttempt.indexOf('{');
                const secondLastBrace = cleanSecondAttempt.lastIndexOf('}');

                if (secondFirstBrace !== -1 && secondLastBrace !== -1 && secondLastBrace > secondFirstBrace) {
                    cleanSecondAttempt = cleanSecondAttempt.substring(secondFirstBrace, secondLastBrace + 1);
                } else {
                    throw new Error("Некоректна відповідь Groq після двох спроб.");
                }

                return JSON.parse(cleanSecondAttempt);
            }
        }


        // =======================================================
        // ФУНКЦІЇ НАЛАШТУВАНЬ ТА API КЛЮЧА
        // =======================================================

        async function testKey() {
            const key = apiKeyInput.value.trim();
            if (!key) return showStatus(keyStatus, 'Введи ключ!', 'error');

            showStatus(keyStatus, 'Тестування...', 'loading');
            refreshModelsBtn.disabled = true;

            const testMessage = [
                { role: 'user', content: 'Say "OK"' }
            ];

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${key}`
                    },
                    body: JSON.stringify({
                        model: FALLBACK_MODELS[0].id,
                        messages: testMessage,
                        max_tokens: 10,
                        temperature: 0.1
                    })
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error ? errorData.error.message : `HTTP ${res.status}`);
                }

                showStatus(keyStatus, '✅ Ключ працює!', 'success');
                loadModels(true); // Завантажити моделі після успішного тесту
            } catch (e) {
                console.error(e);
                showStatus(keyStatus, `⚠️ Помилка: ${e.message.substring(0, 50)}...`, 'error');
                refreshModelsBtn.disabled = false;
            }
        }

        async function loadModels(force = false) {
            const key = apiKeyInput.value.trim();
            if (!key) return showStatus(modelStatus, 'Введи ключ!', 'error');
            if (!force && models.length > 0) return true;

            showStatus(modelStatus, 'Завантаження...', 'loading');
            
            try {
                const res = await fetch(MODELS_URL, {
                    headers: { 'Authorization': `Bearer ${key}` }
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                const data = await res.json();
                models = data.data || [];
                populateModelSelect();
                showStatus(modelStatus, `✅ ${models.length} моделей`, 'success');
                enableUI();
                return true;
            } catch (e) {
                console.error(e);
                showStatus(modelStatus, '⚠️ Використовую резервний список', 'error');
                models = FALLBACK_MODELS;
                populateModelSelect();
                enableUI();
                return false;
            }
        }

        function populateModelSelect() {
            modelSelect.innerHTML = '';
            models.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.id;
                opt.textContent = m.id;
                modelSelect.appendChild(opt);
            });

            const savedModel = localStorage.getItem(MODEL_STORAGE_KEY);
            if (savedModel && models.some(m => m.id === savedModel)) {
                modelSelect.value = savedModel;
                selectedModel = savedModel;
            } else if (models.length > 0) {
                // Вибираємо модель за замовчуванням: llama-3.1-70b-versatile, llama-3.3-70b-versatile, або першу
                const defaultModel = models.find(m => m.id === 'llama-3.1-70b-versatile') || models.find(m => m.id === 'llama-3.3-70b-versatile') || models[0];
                selectedModel = defaultModel.id;
                modelSelect.value = selectedModel;
                localStorage.setItem(MODEL_STORAGE_KEY, selectedModel);
            }
        }

        function enableUI() {
            modelSelect.disabled = false;
            refreshModelsBtn.disabled = false;
            generateTestBtn.disabled = false;
            suggestThemeBtn.disabled = false;
        }

        function showStatus(el, msg, type) {
            el.textContent = msg;
            el.className = `status ${type}`;
        }

        apiKeyInput.addEventListener('change', () => {
            const key = apiKeyInput.value.trim();
            if (key) localStorage.setItem(KEY_STORAGE_KEY, key);
        });

        modelSelect.addEventListener('change', () => {
            selectedModel = modelSelect.value;
            localStorage.setItem(MODEL_STORAGE_KEY, selectedModel);
        });

        // Логіка для селектора складності
        function populateDifficultySelect() {
            difficultySelect.innerHTML = '';
            DIFFICULTIES.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.id;
                opt.textContent = d.name;
                difficultySelect.appendChild(opt);
            });

            difficultySelect.value = selectedDifficulty;
            updateCreativityFromDifficulty();
        }

        difficultySelect.addEventListener('change', () => {
            selectedDifficulty = difficultySelect.value;
            localStorage.setItem(DIFFICULTY_STORAGE_KEY, selectedDifficulty);
            // Оновлюємо креативність тільки якщо користувач не змінював її вручну
            if (!creativityManuallyChanged) {
                 updateCreativityFromDifficulty();
            }
        });

        function updateCreativityFromDifficulty() {
            const diff = DIFFICULTIES.find(d => d.id === selectedDifficulty);
            if (diff) {
                currentCreativity = diff.temp;
                creativitySlider.value = currentCreativity;
                creativityValueEl.textContent = currentCreativity.toFixed(1);
                localStorage.setItem(CREATIVITY_STORAGE_KEY, currentCreativity);
            }
        }

        creativitySlider.addEventListener('input', () => {
            currentCreativity = parseFloat(creativitySlider.value);
            creativityValueEl.textContent = currentCreativity.toFixed(1);
            localStorage.setItem(CREATIVITY_STORAGE_KEY, currentCreativity);
            creativityManuallyChanged = true;
        });
        
        // =======================================================
        // ЛОГІКА ПЕРЕМИКАННЯ ПІДКАЗОК (ВІДНОВЛЕНО)
        // =======================================================
        function setupHintsToggle() {
            // Завантажуємо стан, за замовчуванням true (показувати)
            let showAiHints = localStorage.getItem(HINTS_TOGGLE_STORAGE) !== 'false';
            aiHintsToggle.checked = showAiHints;
            
            aiHintsToggle.addEventListener('change', () => {
                const isChecked = aiHintsToggle.checked;
                localStorage.setItem(HINTS_TOGGLE_STORAGE, isChecked);
                // Оновлюємо відображення, якщо ми на екрані тестування
                if (testScreen.style.display === 'block') {
                    aiHelper.style.display = isChecked ? 'block' : 'none';
                }
            });
        }


        // =======================================================
        // ЛОГІКА ІСТОРІЇ ТА СТАРТОВОГО ЕКРАНА
        // =======================================================

        function loadHistory() {
            const savedHistory = localStorage.getItem(STORAGE_KEY);
            if (savedHistory) {
                history = JSON.parse(savedHistory);
            } else {
                history = [];
            }
        }

        function saveHistory() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
            renderHistory();
        }

        // НОВА ФУНКЦІЯ: ЗБІР ТЕМ ДЛЯ ВИКЛЮЧЕННЯ
        // ==============================================================
        function getExcludedThemes() {
            const usedThemes = history.map(item => item.theme.replace(' (ДЕМО)', ''));
            const presetThemes = PRESET_THEMES.map(item => item.theme.replace(/[🌊⚔️🐋🍞]/g, '').trim());
            const recentUsedThemes = usedThemes.slice(-10);
            const allThemes = [...new Set([...recentUsedThemes, ...presetThemes])];
            return allThemes.join(', ');
        }


        suggestThemeBtn.onclick = async () => {
            if (!selectedModel) return alert('Обери модель!');

            themeSuggestion.classList.add('show');
            toggleLoader(true, '🤔 ІІ думає над темою...');

            const excludedThemes = getExcludedThemes();
            const exclusionInstruction = excludedThemes ? ` (Уникай тем, які вже були, включаючи: ${excludedThemes})` : '';

            const systemContent = 'Ти — біблійний експерт. Відповідай коротко, українською.';
            const userPrompt = `Створи коротку цікаву біблійну тему для відкритого завдання (1-3 слова), яка містить глибокий богословський сенс${exclusionInstruction}. Відповідай лише темою, без лапок і пояснень. Приклад: Життя в пустелі`;

            const messages = [
                { role: 'system', content: systemContent },
                { role: 'user', content: userPrompt }
            ];

            try {
                const suggested = await callGroqAPI(messages, 30, currentCreativity);
                if (!suggested || suggested.length < 3) {
                    throw new Error('Некоректна відповідь від ІІ');
                }
                const cleanSuggested = suggested.replace(/['"]/g, '').trim();
                themeSuggestion.textContent = `💡 Спробуй: "${cleanSuggested}"`;
                themeInput.value = cleanSuggested;
            } catch (e) {
                themeSuggestion.innerHTML = `
                    <span style="color:red; font-weight: bold;">❌ Помилка:</span> Не вдалося згенерувати тему. <span style="display: block; margin-top: 5px;">Спробуйте знову, а якщо помилка повториться — змініть модель ІІ в налаштуваннях ⚙️.</span>
                `;
                console.error(e);
            } finally {
                toggleLoader(false);
            }
        };

        async function generateTest(theme, isRetry = false) {
            if (!selectedModel) return alert('Обери модель!');
            
            const existing = history.find(h => h.theme === theme);
            if (existing && !isRetry && !theme.includes('(ДЕМО)')) {
                if (!confirm(`Тема "${theme}" вже була. Продовжити чи створити нову?`)) {
                    themeInput.value = '';
                    return;
                }
            }
            
            // ОЧИСТКА СОХРАНЕННОГО ПРОГРЕССА ПРИ НАЧАЛЕ НОВОГО ТЕСТУ
            clearSavedProgress();
            restoreTestBanner.classList.remove('show');
            
            // Запуск музыки
            if (music.paused && musicSelect.value !== 'none') {
                music.play().catch(e => console.log('Music autoplay failed:', e));
            }

            const diff = DIFFICULTIES.find(d => d.id === selectedDifficulty);
            const systemPrompt = diff.system;
            const userPrompt = diff.user_template.replace('${theme}', theme);
            const temperature = diff.temp; // Використовуємо Temperature, рекомендовану для складності
            
            toggleLoader(true, '🧠 ІІ генерує завдання...');
            
            // Скидання інтерфейсу
            startScreen.style.display = 'none';
            resultContainer.classList.remove('show');
            testScreen.style.display = 'block';
            currentThemeTitle.textContent = theme;
            document.getElementById('insight-badge').textContent = `Рівень: ${diff.name}`;
            answerInput.style.display = 'block';

            const messages = [
                { role: 'system', content: systemPrompt },
                { role: 'user', content: userPrompt }
            ];

            try {
                // Виклик API для генерації завдання
                const jsonStr = await callGroqAPI(messages, 2500, temperature);
                const parsedTest = await parseAndValidateJSON(jsonStr, messages, 2500);

                currentTest = parsedTest;
                currentTest.theme = theme;
                currentTest.date = new Date().toLocaleDateString('uk-UA');
                currentQuestion = 0;
                userAnswers = {};
                aiGrades = {}; // Скидання оцінок

                renderQuestion();
                updateProgress();
                saveProgress();

                prevBtn.disabled = true; // Сброс
                nextBtn.disabled = false; // Сброс

            } catch (e) {
                const failedTheme = theme;
                questionTextOpen.innerHTML = `
                    <div style="text-align: center; padding: 20px; background: #f8d7da; border-radius: 10px; border: 1px solid #f5c6cb;">
                        <p style="color: #721c24; font-weight: 600; margin-bottom: 15px;">❌ Помилка генерації питань:</p>
                        <p style="color: #721c24; margin-bottom: 20px;">Не вдалося отримати коректне завдання навіть після повторної спроби. Спробуйте змінити тему або модель ІІ в налаштуваннях ⚙️. ${e.message}</p>
                        <button class="btn btn-primary" id="retry-generation-btn">🔄 Повторити генерацію</button>
                    </div>
                `;
                document.getElementById('retry-generation-btn').onclick = () => {
                    generateTest(failedTheme, true);
                };
                
                // ОТКЛЮЧАЕМ НАВИГАЦИЮ ПРИ ОШИБКЕ
                nextBtn.disabled = true;
                prevBtn.disabled = true;
                answerInput.style.display = 'none';
                aiHelper.style.display = 'none'; // Сховати помічника при помилці
                console.error(e);
            } finally {
                toggleLoader(false);
            }
        }

        // --- ЛОГИКА СОХРАНЕНИЯ ПРОГРЕССА ---
        function saveProgress() {
            if (currentTest) {
                localStorage.setItem(CURRENT_TEST_STORAGE, JSON.stringify(currentTest));
                localStorage.setItem(CURRENT_QUESTION_STORAGE, currentQuestion);
                localStorage.setItem(USER_ANSWERS_STORAGE, JSON.stringify(userAnswers));
                localStorage.setItem(AI_GRADES_STORAGE, JSON.stringify(aiGrades));
            }
        }

        function loadProgress() {
            const savedTestStr = localStorage.getItem(CURRENT_TEST_STORAGE);
            const savedQ = localStorage.getItem(CURRENT_QUESTION_STORAGE);
            const savedAnswersStr = localStorage.getItem(USER_ANSWERS_STORAGE);
            const savedGradesStr = localStorage.getItem(AI_GRADES_STORAGE);

            if (savedTestStr && savedQ !== null) {
                try {
                    currentTest = JSON.parse(savedTestStr);
                    currentQuestion = parseInt(savedQ);
                    userAnswers = JSON.parse(savedAnswersStr || '{}');
                    aiGrades = JSON.parse(savedGradesStr || '{}');

                    restoredThemeName.textContent = currentTest.theme;
                    restoreTestBanner.classList.add('show');
                } catch (e) {
                    console.error("Error loading progress:", e);
                    clearSavedProgress();
                }
            } else {
                clearSavedProgress();
            }
        }

        function clearSavedProgress() {
            localStorage.removeItem(CURRENT_TEST_STORAGE);
            localStorage.removeItem(CURRENT_QUESTION_STORAGE);
            localStorage.removeItem(USER_ANSWERS_STORAGE);
            localStorage.removeItem(AI_GRADES_STORAGE);
            restoreTestBanner.classList.remove('show');
        }

        restoreBtn.onclick = () => {
            // Запуск музыки
            if (music.paused && musicSelect.value !== 'none') {
                music.play().catch(e => console.log('Music autoplay failed:', e));
            }
            startScreen.style.display = 'none';
            resultContainer.classList.remove('show');
            testScreen.style.display = 'block';
            
            const diff = DIFFICULTIES.find(d => d.id === selectedDifficulty);

            currentThemeTitle.textContent = currentTest.theme;
            document.getElementById('insight-badge').textContent = `Рівень: ${diff.name}`;
            answerInput.style.display = 'block';

            renderQuestion();
            updateProgress();
            restoreTestBanner.classList.remove('show');
        };

        // --- ЛОГИКА ТЕСТИРОВАНИЯ ---

        function renderQuestion() {
            const q = currentTest.questions[currentQuestion];
            const currentAnswer = userAnswers[currentQuestion] || '';
            let showAiHints = localStorage.getItem(HINTS_TOGGLE_STORAGE) !== 'false';

            questionTextOpen.textContent = q.q;
            answerInput.value = currentAnswer;

            const criteriaList = q.correct_criteria.map(c => `<li>${c}</li>`).join('');

            aiHelper.innerHTML = `
                <p><strong>💡 Біблійний вірш для підказки:</strong> ${q.verse_key}</p>
                <p style="margin-top: 10px;"><strong>⚖️ Очікувані елементи (критерії оцінювання):</strong></p>
                <ul style="margin-left: 20px; list-style-type: circle;">${criteriaList}</ul>
            `;
            
            // Встановлюємо видимість помічника відповідно до перемикача
            aiHelper.style.display = showAiHints ? 'block' : 'none';

            answerInput.oninput = () => {
                userAnswers[currentQuestion] = answerInput.value;
                saveProgress();
            };

            questionCounter.textContent = `Завдання ${currentQuestion + 1} з ${currentTest.questions.length}`;
            prevBtn.disabled = currentQuestion === 0;
            nextBtn.textContent = currentQuestion === currentTest.questions.length - 1 ? 'Завершити та Оцінити ✅' : 'Далі ➡️';
        }

        function updateProgress() {
            const perc = ((currentQuestion) / currentTest.questions.length) * 100;
            progress.style.width = `${perc}%`;
        }

        prevBtn.onclick = () => {
            if (currentQuestion > 0) {
                currentQuestion--;
                renderQuestion();
                updateProgress();
                saveProgress();
            }
        };

        nextBtn.onclick = () => {
            const currentAnswer = userAnswers[currentQuestion] || '';
            if (currentAnswer.trim().length < 5) {
                alert('Будь ласка, введіть відповідь (мінімум 5 символів).');
                return;
            }

            if (currentQuestion < currentTest.questions.length - 1) {
                currentQuestion++;
                renderQuestion();
                updateProgress();
                saveProgress();
            } else {
                finishTest();
            }
        };

        // =======================================================
        // НОВА ФУНКЦІЯ: ОЦІНЮВАННЯ ВІДПОВІДІ ШІ
        // =======================================================
        async function gradeAnswer(task, userAnswer) {
            const criteriaList = task.correct_criteria.join(', ');
            const userPrompt = `Завдання: "${task.q}". Ключові критерії: [${criteriaList}]. Відповідь учня: "${userAnswer}". Оціни.`;

            const messages = [
                { role: 'system', content: GRADING_SYSTEM_PROMPT },
                { role: 'user', content: userPrompt }
            ];

            try {
                // Використовуємо низьку креативність (0.2) для максимально точної оцінки
                const jsonStr = await callGroqAPI(messages, 800, 0.2); 
                const grade = await parseAndValidateJSON(jsonStr, messages, 800);
                // Перевірка, чи бал знаходиться в діапазоні 1-5
                grade.score = Math.max(1, Math.min(5, parseInt(grade.score)));
                return grade;
            } catch (e) {
                console.error("Помилка при оцінюванні Groq:", e);
                // Повертаємо мінімальний бал у разі помилки, щоб не завищувати результат
                return { score: 1, feedback: 'Помилка ШІ: не вдалося оцінити відповідь.', missing_elements: [], insight_verse: task.verse_key };
            }
        }

        // =======================================================
        // ФУНКЦІЯ ЗАВЕРШЕННЯ ТЕСТУ
        // =======================================================

        async function finishTest() {
            const totalQuestions = currentTest.questions.length;
            const grades = {};
            
            toggleLoader(true, '🧠 Починаємо оцінювання ваших відповідей...');

            for (let i = 0; i < totalQuestions; i++) {
                const q = currentTest.questions[i];
                const answer = userAnswers[i] || '';

                if (answer.trim().length < 5) {
                    // Якщо відповідь порожня (менше 5 симв.), ставимо мінімальний бал
                    grades[i] = { score: 1, feedback: 'Відповідь була надто короткою або порожньою. Оцінка: 1/5.', missing_elements: [], insight_verse: q.verse_key };
                } else {
                    loadingMessage.textContent = `🧠 Оцінювання відповіді ${i + 1} з ${totalQuestions}...`;
                    const gradeResult = await gradeAnswer(q, answer);
                    grades[i] = gradeResult;
                }
            }

            aiGrades = grades;
            localStorage.setItem(AI_GRADES_STORAGE, JSON.stringify(aiGrades));
            
            toggleLoader(false);
            clearSavedProgress(); // Видаляємо прогрес після завершення оцінювання
            displayFinalResults();
        }

        // =======================================================
        // ФУНКЦІЯ ВІДОБРАЖЕННЯ РЕЗУЛЬТАТІВ
        // =======================================================

        function displayFinalResults() {
            const totalScore = Object.values(aiGrades).reduce((sum, grade) => sum + grade.score, 0);
            const maxScore = currentTest.questions.length * 5;
            const totalTasks = currentTest.questions.length;
            const averageScore = totalScore / totalTasks;

            // Визначення рівня (insight) на основі середнього балу (max 5)
            const insight = Math.min(5, Math.ceil(averageScore));
            const levels = ['Новачок', 'Початківець', 'Дослідник', 'Експерт', 'Майстер'];

            const existingIndex = history.findIndex(h => h.theme === currentTest.theme);
            
            // Зберігаємо повний тест та оцінки для можливості перегляду історії
            const result = { 
                theme: currentTest.theme, 
                score: totalScore, 
                total: maxScore, 
                date: currentTest.date, 
                insight,
                fullTest: currentTest,    // <-- ЗБЕРЕЖЕННЯ ПОВНИХ ДАНИХ
                fullGrades: aiGrades      // <-- ЗБЕРЕЖЕННЯ ПОВНИХ ДАНИХ
            };
            
            if (existingIndex >= 0) history[existingIndex] = result;
            else history.push(result);
            saveHistory();

            testScreen.style.display = 'none';
            resultContainer.classList.add('show');
            
            scoreEl.textContent = `${totalScore}/${maxScore}`;

            let message = '';
            if (averageScore >= 4.5) message = '🎉 Ідеально! Ти — Майстер Слідопит!';
            else if (averageScore >= 3.5) message = '👏 Дуже добре! Твої знання глибокі.';
            else if (averageScore >= 2.5) message = '👍 Добре, але потрібен більший аналіз.';
            else message = '💪 Почни знову, деталізуй відповіді!';
            
            resultMsg.textContent = message;
            document.getElementById('result-insight').textContent = `Рівень: ${insight} (${levels[insight-1]})`;

            // Вибір вірша для підказки
            const allInsightVerses = Object.values(aiGrades).filter(g => g.insight_verse).map(g => g.insight_verse);
            const uniqueInsightVerses = [...new Set(allInsightVerses)];
            const randomVerse = uniqueInsightVerses.length > 0 ? uniqueInsightVerses[Math.floor(Math.random() * uniqueInsightVerses.length)] : 'Ів. 3:16';
            
            hiddenVerse.textContent = `🌟 Підказка дня (Ключовий вірш для роздумів): ${randomVerse}`;
            hiddenVerse.classList.add('show');

            answersReview.innerHTML = currentTest.questions.map((q, i) => {
                const grade = aiGrades[i];
                const userA = userAnswers[i] || '— Відповідь відсутня —';
                const gradeClass = grade.score >= 4 ? 'good' : grade.score >= 2 ? 'medium' : 'poor';
                
                const missingHtml = grade.missing_elements && grade.missing_elements.length > 0
                    ? `<p style="color:#dc3545; margin-top: 10px;"><strong>❌ Пропущено:</strong> ${grade.missing_elements.join('; ')}</p>`
                    : `<p class="correct-text" style="margin-top: 10px;">✅ Всі ключові елементи присутні.</p>`;

                return `
                    <div class="review-item ${gradeClass}">
                        <h4>Завдання ${i + 1}: ${q.q}</h4>
                        <p style="margin-top: 5px;"><strong>Оцінка ІІ:</strong> <span style="font-size: 1.2rem; font-weight: bold; color: ${gradeClass === 'good' ? '#28a745' : gradeClass === 'medium' ? '#ffc107' : '#dc3545'};">${grade.score}/5</span></p>
                        <p style="margin-top: 5px;"><strong>Ключовий вірш:</strong> ${q.verse_key} (критерій)</p>
                        <div class="user-answer-box">
                            <p><strong>Ваша відповідь:</strong></p>
                            <p>${userA}</p>
                        </div>
                        <div class="feedback-box">
                            <p><strong>Відгук ІІ:</strong> ${grade.feedback}</p>
                            ${missingHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- ЛОГІКА ІСТОРІЇ ---

        // ЗМІНЕНА ФУНКЦІЯ: Тепер коректно відновлює дані для відображення результатів
        function loadTestFromHistory(reversedIndex) {
            
            // Оскільки в renderHistory ми проходимося по історії у зворотному порядку (slice().reverse()),
            // нам потрібно обчислити справжній індекс
            const actualHistoryIndex = history.length - 1 - reversedIndex;
            const item = history[actualHistoryIndex];

            if (!item || !item.fullTest || !item.fullGrades) {
                alert('Повний запис результатів тестування не знайдено для цієї теми. Спробуйте іншу або пройдіть тест знову.');
                return;
            }

            // Відновлюємо дані для відображення результатів
            currentTest = item.fullTest;
            aiGrades = item.fullGrades;
            // Відповіді користувача не зберігаються в історії, але для відображення нам потрібні лише питання та оцінки
            userAnswers = {}; 
            // Відновлення відповідей користувача (якщо потрібно для review)
            currentTest.questions.forEach((q, i) => {
                 // Використовуємо відповіді з MOCK_ANSWERS якщо це демо-тест, інакше ставимо порожню строку
                 userAnswers[i] = item.theme.includes('(ДЕМО)') ? MOCK_ANSWERS[i] : item.fullGrades[i].feedback.includes('Відповідь була надто короткою') ? '— Відповідь відсутня —' : ''; // Тут потрібна була б повна відповідь, якщо б вона зберігалась. Для демо-тесту ми її імітуємо.
            });

            // Перехід на екран результатів
            startScreen.style.display = 'none';
            testScreen.style.display = 'none';
            resultContainer.classList.add('show');
            
            displayFinalResults(); // Відобразить відновлені результати
        }

        // ЗМІНЕНА ФУНКЦІЯ: Коректно відображає історію та прив'язує індекси
        function renderHistory() {
            historyList.innerHTML = '';
            
            if (history.length === 0 && PRESET_THEMES.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #777;">Поки немає доступних тем</p>';
                return;
            }

            // Рендер Пресетів
            PRESET_THEMES.forEach((item, i) => {
                const div = document.createElement('div');
                div.className = 'history-card preset';
                div.innerHTML = `
                    <div class="history-card-title">${item.theme}</div>
                    <div class="history-card-score" style="color: #004D40;">✨ Нове завдання</div>
                    <div class="history-card-date">Натисни щоб почати</div>
                `;
                div.onclick = () => {
                    const cleanTheme = item.theme.replace(/[🌊⚔️🐋🍞]/g, '').trim();
                    themeInput.value = cleanTheme;
                    // Встановлення складності з пресету
                    selectedDifficulty = item.difficulty;
                    difficultySelect.value = selectedDifficulty;
                    updateCreativityFromDifficulty();
                    generateTest(cleanTheme, false);
                };
                historyList.appendChild(div);
            });

            // Рендер Актуальної Історії (у зворотному порядку)
            const reversedHistory = history.slice().reverse();
            reversedHistory.forEach((item, i) => {
                const div = document.createElement('div');
                
                // Обчислення середнього балу для відображення
                const avgScore = (item.score / item.total) * 5; 
                const displayScore = Math.round(avgScore * 10) / 10;
                
                div.className = `history-card insight-${item.insight}`;
                div.innerHTML = `
                    <div class="history-card-title">${item.theme}</div>
                    <div class="history-card-score">${displayScore}/5 (середній бал)</div>
                    <div class="history-card-date">${item.date}</div>
                `;
                // Передаємо індекс у ЗВОРОТНЬОМУ списку для коректного відновлення
                div.onclick = () => {
                    loadTestFromHistory(i); 
                };
                historyList.appendChild(div);
            });
        }
        
        showHistoryBtn.onclick = () => {
            historyList.classList.toggle('show');
            renderHistory();
        };

        clearHistoryBtn.onclick = () => {
            if (confirm('Очистити всю історію аналізів? Це незворотна дія.')) {
                history = [];
                saveHistory();
                alert('Історія очищена.');
                settingsModal.classList.remove('show');
            }
        };


        // --- ЛОГІКА МУЗИКИ ---

        function setMusicSource(trackId) {
            const selectedTrack = MUSIC_TRACKS.find(t => t.id === trackId);
            if (selectedTrack && selectedTrack.url) {
                music.src = selectedTrack.url;
                music.play().catch(e => console.log('Music autoplay failed:', e));
                musicToggle.textContent = '⏸️';
            } else {
                music.pause();
                music.src = '';
                musicToggle.textContent = '🎵';
            }
        }

        musicSelect.addEventListener('change', (e) => {
            const trackId = e.target.value;
            localStorage.setItem(MUSIC_STORAGE_KEY, trackId);
            setMusicSource(trackId);
        });

        musicToggle.onclick = () => {
            if (music.paused) {
                music.play().catch(e => console.log('Music autoplay failed:', e));
                musicToggle.textContent = '⏸️';
                if (musicSelect.value === 'none') {
                    musicSelect.value = 'default';
                    localStorage.setItem(MUSIC_STORAGE_KEY, 'default');
                    setMusicSource('default');
                }
            } else {
                music.pause();
                musicToggle.textContent = '🎵';
            }
        };

        volumeSlider.oninput = (e) => {
            currentVolume = parseFloat(e.target.value);
            music.volume = currentVolume / 100;
            localStorage.setItem(VOLUME_STORAGE_KEY, currentVolume);
        };

        // =======================================================
        // ОСНОВНА ІНІЦІАЛІЗАЦІЯ
        // =======================================================
        
        function goHome() {
            testScreen.style.display = 'none';
            resultContainer.classList.remove('show');
            startScreen.style.display = 'block';
            themeInput.value = currentTest ? currentTest.theme.replace(' (ДЕМО)', '') : '';
            clearSavedProgress();
            renderHistory();
        }

        homeBtn.onclick = goHome;
        homeBtn2.onclick = goHome;
        retryBtn.onclick = () => {
            goHome();
            generateTest(currentTest.theme.replace(' (ДЕМО)', ''), true);
        };


        document.addEventListener('DOMContentLoaded', async () => {
            loadHistory();
            
            // Modal events
            settingsBtn.onclick = () => settingsModal.classList.add('show');
            closeModal.onclick = () => settingsModal.classList.remove('show');
            window.onclick = (event) => {
                if (event.target === settingsModal) settingsModal.classList.remove('show');
                if (event.target === helpModal) helpModal.classList.remove('show');
            };
            helpBtn.onclick = () => helpModal.classList.add('show');
            closeHelpModal.onclick = () => helpModal.classList.remove('show');
            
            // Settings events
            testKeyBtn.onclick = testKey;
            refreshModelsBtn.onclick = () => loadModels(true);
            
            // Встановлення обробника для Підказок AI
            setupHintsToggle();

            // Set initial values from storage
            const savedKey = localStorage.getItem(KEY_STORAGE_KEY);
            if (savedKey) apiKeyInput.value = savedKey;
            
            // Якщо є hardcoded ключ, використовуємо його, якщо localstorage порожній
            if (!savedKey && apiKeyInput.value.trim() !== '') {
                localStorage.setItem(KEY_STORAGE_KEY, apiKeyInput.value.trim());
            }

            populateDifficultySelect();

            const savedMusic = localStorage.getItem(MUSIC_STORAGE_KEY) || 'default';
            musicSelect.value = savedMusic;
            const selectedTrack = MUSIC_TRACKS.find(t => t.id === savedMusic);
            if (selectedTrack && selectedTrack.url) {
                music.src = selectedTrack.url;
            } else if (savedMusic === 'none') {
                music.src = '';
            }
            
            const savedVolume = localStorage.getItem(VOLUME_STORAGE_KEY);
            if (savedVolume !== null) {
                currentVolume = parseFloat(savedVolume);
            }
            volumeSlider.value = currentVolume;
            music.volume = currentVolume / 100;

            const savedCreativity = localStorage.getItem(CREATIVITY_STORAGE_KEY);
            if (savedCreativity !== null) {
                currentCreativity = parseFloat(savedCreativity);
                creativityManuallyChanged = true; 
            } else {
                updateCreativityFromDifficulty();
            }

            if (creativitySlider && creativityValueEl) {
                creativitySlider.value = currentCreativity;
                creativityValueEl.textContent = currentCreativity.toFixed(1);
            }

            // ПРОВЕРКА И ВОССТАНОВЛЕНИЕ ПРОГРЕССА
            loadProgress();

            loadModels().then(() => renderHistory());

            // ПРИВ'ЯЗКА ФУНКЦІЇ ДЕМОНСТРАЦІЇ
            if (showExampleBtn) {
                showExampleBtn.onclick = loadExampleTest;
            }
            
            // Клік по "Створити завдання"
            generateTestBtn.onclick = () => {
                const theme = themeInput.value.trim();
                if (!theme) return alert('Будь ласка, введіть тему.');
                generateTest(theme, false);
            };
        });
    </script>
</body>
</html>