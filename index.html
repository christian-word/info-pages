<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Розпізнавання та переклад тексту пісні</title>
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #222;
      --primary: #1a73e8;
      --success: #2f7d32;
      --danger: #b00020;
      --warning: #ff9800;
      --border: #e5e5e5;
      --hover: #f0f0f0;
    }
    [data-theme="dark"] {
      --bg: #1a1a1a;
      --card: #2d2d2d;
      --text: #ffffff;
      --border: #444;
      --hover: #383838;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      width: 100%;
      margin: 0 auto;
      background: var(--card);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      margin-top: 0;
      color: var(--primary);
    }
    .description {
      text-align: center;
      color: var(--text);
      margin-bottom: 20px;
      font-size: 14px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }
    input[type="file"] {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      color: var(--text);
      font-size: 16px;
    }
    select {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      color: var(--text);
      font-size: 16px;
      margin-bottom: 15px;
    }
    button {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--primary);
      color: white;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    button:hover:not(:disabled) {
      background: #0d5cb6;
    }
    button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    .result {
      margin-top: 20px;
      padding: 16px;
      border-radius: 8px;
      background: var(--bg);
      border: 1px solid var(--border);
      white-space: pre-wrap;
      min-height: 50px;
    }
    .status {
      text-align: center;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .status.success {
      background: rgba(47, 125, 50, 0.1);
      color: var(--success);
      border: 1px solid var(--success);
    }
    .status.error {
      background: rgba(176, 0, 32, 0.1);
      color: var(--danger);
      border: 1px solid var(--danger);
    }
    .status.warning {
      background: rgba(255, 152, 0, 0.1);
      color: var(--warning);
      border: 1px solid var(--warning);
    }
    .hidden {
      display: none;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
      vertical-align: middle;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    audio {
        width: 100%;
        margin-top: 10px;
    }
    .info-box {
      background-color: rgba(26, 115, 232, 0.1);
      border: 1px solid var(--primary);
      border-radius: 8px;
      padding: 12px;
      margin-top: 15px;
      font-size: 13px;
    }
    .actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    .actions button {
        flex: 1;
    }
    #save-btn {
        background: var(--success);
    }
    #save-btn:hover:not(:disabled) {
        background: #256528;
    }
    #copy-btn {
        background: #6c757d;
    }
    #copy-btn:hover:not(:disabled) {
        background: #5a6268;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🎤 Для внутрішнього використання церкви</h1>
    <p class="description">Розпізнавання та переклад тексту пісні. Завантажте аудіофайл (MP3, WAV, M4A) для отримання тексту пісні</p>
    <div id="status" class="status hidden"></div>
    <div class="form-group">
      <label for="audio-file">Аудіофайл:</label>
      <input type="file" id="audio-file" accept="audio/*" />
      <audio id="audio-preview" controls class="hidden"></audio>
      
      <label for="target-language">Мова розпізнавання/перекладу:</label>
      <select id="target-language">
        <option value="uk">Українська</option>
        <option value="en">Англійська</option>
        <option value="ru">Російська</option>
      </select>
    </div>
    <button id="transcribe-btn" disabled>
      <span id="button-text">Розпізнати та перекласти</span>
    </button>
    <div class="info-box">
      <strong>ℹ️ Як це працює:</strong> Ця сторінка використовує модель ШІ Whisper для перетворення мовлення з аудіо в текст. Ви можете вибрати мову, на якій буде розпізнано текст. Чим чіткіше звучить спів, тим точнішим буде результат.
    </div>
    <div id="result-container" class="hidden">
        <div id="result" class="result"></div>
        <div class="actions">
            <button id="copy-btn">📋 Копіювати</button>
            <button id="save-btn">💾 Зберегти</button>
        </div>
    </div>
  </div>
  <script>
    /* =========================
      API CONFIGURATION
      ========================= */
    const encrypted = "Z3NrX1NUelQyS1FFQko3MGNDb1hDSllaV0dkeWIzRlk5OHJHN2xvWXUxSmc1SnV0VFZOSzIyVHY=";
    const apiKey = atob(encrypted);
    const API_URL = "https://api.groq.com/openai/v1/audio/transcriptions";
    /* =========================
      UTILITY FUNCTIONS
      ========================= */
    function showStatus(message, type = 'success') {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
      statusEl.classList.remove('hidden');
    }
    function hideStatus() {
      document.getElementById('status').classList.add('hidden');
    }
    function showResult(content) {
      const container = document.getElementById('result-container');
      const resultEl = document.getElementById('result');
      resultEl.textContent = content;
      container.classList.remove('hidden');
    }
    function hideResult() {
      document.getElementById('result-container').classList.add('hidden');
    }
    function setButtonLoading(isLoading) {
      const button = document.getElementById('transcribe-btn');
      const buttonText = document.getElementById('button-text');
      if (isLoading) {
        button.disabled = true;
        buttonText.innerHTML = '<span class="loading"></span> Обробка...';
      } else {
        button.disabled = false;
        buttonText.textContent = 'Розпізнати та перекласти';
      }
    }
    /* =========================
      AUDIO HANDLING
      ========================= */
    document.getElementById('audio-file').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const button = document.getElementById('transcribe-btn');
      const preview = document.getElementById('audio-preview');
      if (file) {
        button.disabled = false;
        // Створюємо попередній перегляд аудіо
        const url = URL.createObjectURL(file);
        preview.src = url;
        preview.classList.remove('hidden');
      } else {
        button.disabled = true;
        preview.classList.add('hidden');
        preview.src = '';
      }
    });
    /* =========================
      TRANSCRIPTION & TRANSLATION FUNCTION
      ========================= */
    async function transcribeAndTranslate() {
      hideStatus();
      hideResult();
      setButtonLoading(true);
      const fileInput = document.getElementById('audio-file');
      const languageSelect = document.getElementById('target-language');
      const file = fileInput.files[0];
      const targetLanguage = languageSelect.value;

      if (!file) {
        showStatus('Будь ласка, оберіть аудіофайл', 'error');
        setButtonLoading(false);
        return;
      }
      // Перевірка розміру файлу (Groq має ліміт 25MB)
      if (file.size > 25 * 1024 * 1024) {
        showStatus('Файл занадто великий. Максимальний розмір 25MB.', 'error');
        setButtonLoading(false);
        return;
      }
      const formData = new FormData();
      formData.append('file', file);
      formData.append('model', 'whisper-large-v3');
      formData.append('response_format', 'text');
      // Встановлюємо мову для розпізнавання/перекладу
      formData.append('language', targetLanguage); 
      
      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${apiKey}`
          },
          body: formData
        });
        if (!res.ok) {
          const errorText = await res.text().catch(() => "Немає деталей помилки");
          throw new Error(`HTTP ${res.status}: ${errorText}`);
        }
        const transcript = await res.text();
        if (!transcript || transcript.trim() === '') {
          showResult('Не вдалося розпізнати текст. Можливо, аудіо занадто тихе, відсутнє мовлення або файл пошкоджений.');
        } else {
          showResult(transcript);
          showStatus(`Текст пісні успішно розпізнано на ${languageSelect.options[languageSelect.selectedIndex].text.toLowerCase()}!`, 'success');
        }
      } catch (err) {
        showResult('');
        showStatus(`Помилка: ${err.message}`, 'error');
        console.error("Transcription Error:", err);
      } finally {
        setButtonLoading(false);
      }
    }
    /* =========================
      SAVE & COPY FUNCTIONS
      ========================= */
    function copyToClipboard() {
        const resultText = document.getElementById('result').textContent;
        navigator.clipboard.writeText(resultText)
            .then(() => {
                showStatus('Текст скопійовано до буфера обміну!', 'success');
            })
            .catch(err => {
                showStatus('Помилка копіювання: ' + err, 'error');
            });
    }
function saveToFile() {
    const resultText = document.getElementById('result').textContent;
    if (!resultText) {
        showStatus('Немає тексту для збереження', 'warning');
        return;
    }

    try {
        const blob = new Blob([resultText], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none'; // Оставим это для скрытия
        a.href = url;
        // Убедитесь, что имя файла не содержит символов, которые могут вызвать проблемы на мобильных устройствах
        a.download = 'tekst_pisni.txt'; // Используйте латиницу и подчеркивания

        document.body.appendChild(a);
        // Используйте непосредственный клик
        a.click();
        
        // Отложено удаляем элемент и URL, но без setTimeout
        // Лучше использовать requestAnimationFrame или Promise.resolve().then()
        // но даже простой отложенный setTimeout часто работает
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100); // Меньшая задержка может быть достаточной

        showStatus('Файл збережено! Якщо завантаження не почалося, перевірте папку "Завантаження" на вашому пристрої.', 'success');
    } catch (err) {
        console.error("Помилка збереження:", err);
        showStatus('Не вдалося зберегти файл: ' + err.message, 'error');
        // Альтернативный вариант для мобильных - показать текст и предложить скопировать вручную
        // Или открыть текст в новом окне/вкладке
        // window.open(URL.createObjectURL(new Blob([resultText], { type: 'text/plain' })), '_blank');
    }
}
    /* =========================
      INITIALIZATION
      ========================= */
    document.addEventListener('DOMContentLoaded', () => {
      // Додаємо обробники подій
      document.getElementById('transcribe-btn').addEventListener('click', transcribeAndTranslate);
      document.getElementById('copy-btn').addEventListener('click', copyToClipboard);
      document.getElementById('save-btn').addEventListener('click', saveToFile);
    });
  </script>
</body>
</html>